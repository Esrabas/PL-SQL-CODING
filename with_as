WITH TARIH AS
( SELECT MIN(DATE_VALUE)-45 MIN_DT ,MAX(DATE_VALUE) MAX_DT FROM EDW.CMN_CALENDAR C
  WHERE C.YEAR_VALUE BETWEEN TO_CHAR(TRUNC(ADD_MONTHS(SYSDATE,-2)),'yyyy') AND TO_CHAR(TRUNC(SYSDATE),'yyyy')
      AND (DAY_OF_WEEK = 5 OR LAST_DAY_OF_MONTH_FLG=1)
      AND (WEEK_OF_YEAR BETWEEN CASE WHEN TO_NUMBER(TO_CHAR(TRUNC(SYSDATE),'IW'))-5 <=0 
                                THEN 52-(5-TO_NUMBER(TO_CHAR(TRUNC(SYSDATE),'IW')))-1 
                                ELSE TO_NUMBER(TO_CHAR(TRUNC(SYSDATE),'IW'))-5 END 
                        AND CASE WHEN TO_NUMBER(TO_CHAR(TRUNC(SYSDATE),'IW'))-5<=0 THEN 52 ELSE TO_NUMBER(TO_CHAR(TRUNC(SYSDATE),'IW'))-1 END 
                        OR 
                        (TO_NUMBER(TO_CHAR(TRUNC(SYSDATE),'IW'))-5 <=0 AND C.YEAR_VALUE=TO_CHAR(TRUNC(SYSDATE),'yyyy') AND WEEK_OF_YEAR BETWEEN 1 AND ABS(TO_NUMBER(TO_CHAR(TRUNC(SYSDATE),'IW'))-5))) 
      AND DATE_VALUE < TRUNC(SYSDATE)),
RAPOR_SIL AS
(SELECT /*+ MATERIALIZE */
     X.PARTY_ID
    ,X.DATA_DATE
    ,C.WEEK_OF_YEAR
    ,X.T0_PORTFOLIO_BRANCH_ID
    ,X.T0_PORTFOLIO_SBU_CODE
    ,CUSTOMER_STATUS_DESC
    ,CASE WHEN ONLY_PRODUCT_SUBSEGMENT_DESC='Only Time Deposit' THEN 1 ELSE 0 END AS ONLY_TIME_DEPOSIT_FLG 
    ,CASE WHEN ONLY_PRODUCT_SUBSEGMENT_DESC='Only Mortgage' THEN 1 ELSE 0 END AS ONLY_MORTGAGE_FLG
 --   ,DECODE(Y.PARTY_ID,NULL,0,1) RELATION_PARTNERSHIP_FLG     
  FROM
    DM.CNF_CUSTOMER_HST X,DM.CNF_CUSTOMER_STATUS_LKP A,DM.CNF_CUST_ONLY_PROD_SUBSEG_LKP B,EDW.CMN_CALENDAR C 
      WHERE C.YEAR_VALUE BETWEEN TO_CHAR(TRUNC(ADD_MONTHS(SYSDATE,-2)),'yyyy') AND TO_CHAR(TRUNC(SYSDATE),'yyyy')
      AND (DAY_OF_WEEK = 5 OR LAST_DAY_OF_MONTH_FLG=1)
      AND (WEEK_OF_YEAR BETWEEN CASE WHEN TO_NUMBER(TO_CHAR(TRUNC(SYSDATE),'IW'))-5 <=0 
                                THEN 52-(5-TO_NUMBER(TO_CHAR(TRUNC(SYSDATE),'IW')))-1 
                                ELSE TO_NUMBER(TO_CHAR(TRUNC(SYSDATE),'IW'))-5 END 
                        AND CASE WHEN TO_NUMBER(TO_CHAR(TRUNC(SYSDATE),'IW'))-5<=0 THEN 52 ELSE TO_NUMBER(TO_CHAR(TRUNC(SYSDATE),'IW'))-1 END 
                        OR 
                        (TO_NUMBER(TO_CHAR(TRUNC(SYSDATE),'IW'))-5 <=0 AND C.YEAR_VALUE=TO_CHAR(TRUNC(SYSDATE),'yyyy') AND WEEK_OF_YEAR BETWEEN 1 AND ABS(TO_NUMBER(TO_CHAR(TRUNC(SYSDATE),'IW'))-5))) 
      AND DATE_VALUE < TRUNC(SYSDATE)
      AND X.DATA_DATE=C.DATE_VALUE       
      AND X.CURRENT_STATUS_ID=A.CUSTOMER_STATUS_ID (+)
      AND X.ONLY_PRODUCT_SUBSEGMENT_ID=B.ONLY_PRODUCT_SUBSEGMENT_ID(+)
      AND X.MVT_STATUS_ID=1 
      AND X.T0_PORTFOLIO_SBU_CODE IN ('430','431','432')),      
      TRX AS ( 
   SELECT /*+ MATERIALIZE */
     A.PARTY_ID
   -- ,A.TRANSACTION_DATE
    ,CL.WEEK_OF_YEAR
    ,1 AS ISLEM_FLAG 
    ,MAX(NVL(MIGRATABLE_FLG,0)) AS MIGRATABLE_ISLEM_FLAG ,
    COUNT(*) NOF_TRANSACTION 
  FROM 
    EDW.TRX_TRANSACTION A , EDW.CMN_CALENDAR CL,EDW.CHN_CHANNEL B, EDW.TRX_TP_LKP C  
  WHERE A.CHANNEL_ID=B.CHANNEL_ID (+)
    AND A.TRANSACTION_TP_ID=C.TRANSACTION_TP_ID (+)           
    AND YEAR_VALUE BETWEEN TO_CHAR(TRUNC(ADD_MONTHS(SYSDATE,-2)),'yyyy') AND TO_CHAR(TRUNC(SYSDATE),'yyyy')     
    AND (WEEK_OF_YEAR BETWEEN CASE WHEN TO_NUMBER(TO_CHAR(TRUNC(SYSDATE),'IW'))-5 <=0 
                                THEN 52-(5-TO_NUMBER(TO_CHAR(TRUNC(SYSDATE),'IW')))-1 
                                ELSE TO_NUMBER(TO_CHAR(TRUNC(SYSDATE),'IW'))-5 END 
                        AND CASE WHEN TO_NUMBER(TO_CHAR(TRUNC(SYSDATE),'IW'))-5<=0 THEN 52 ELSE TO_NUMBER(TO_CHAR(TRUNC(SYSDATE),'IW'))-1 END 
                        OR 
                        (TO_NUMBER(TO_CHAR(TRUNC(SYSDATE),'IW'))-5 <=0 AND YEAR_VALUE=TO_CHAR(TRUNC(SYSDATE),'yyyy') AND WEEK_OF_YEAR BETWEEN 1 AND ABS(TO_NUMBER(TO_CHAR(TRUNC(SYSDATE),'IW'))-5))) 
    AND DATE_VALUE < TRUNC(SYSDATE)  
    AND A.TRANSACTION_DATE=CL.DATE_VALUE
    AND A.TRANSACTION_DATE BETWEEN TRUNC(ADD_MONTHS(TO_DATE(20181228,'yyyymmdd'),-2)) AND TRUNC(TO_DATE(20181228,'yyyymmdd'))
    AND A.TRANSACTION_STAT_ID=1
    AND A.PARTY_ID>0
    AND A.CHANNEL_ID=22
  GROUP BY A.PARTY_ID,CL.WEEK_OF_YEAR
      ),
      CUST_SUM AS (
  SELECT /*+ MATERIALIZE */
    D.PARTY_ID
    ,D.DATA_DATE
    ,NOF_OWN_PRODUCT AS CSELL
    ,NOF_ACTV_PRODUCT AS APU
    ,CUSTOMER_PFA AS PFA 
    ,NOF_OPEN_GPL AS GPL_ADET
    ,NOF_OPEN_MORTGAGE AS MORTGAGE_ADET
  FROM 
    DM.CNF_CUSTOMER_SUMMARY_DAILY D,RAPOR_SIL T
  WHERE D.PARTY_ID = T.PARTY_ID
    AND D.DATA_DATE=T.DATA_DATE
  ),
  CUST_APU AS   (
  SELECT /*+ MATERIALIZE */
     X.PARTY_ID
    ,X.DATA_DATE
    ,ACTV_TIME_DEPOSIT_TL_FLG
    ,ACTV_TIME_DEPOSIT_FX_FLG
    ,ACTV_DEMAND_DEPOSIT_FX_FLG 
    ,ACTV_DEMAND_DEPOSIT_TL_FLG
    ,ACTV_CC_FLG
    ,OWN_CC_FLG 
    ,OWN_OVERDRAFT_FLG
    ,ACTV_GPL_FLG
    ,ACTV_MORTGAGE_FLG 
  FROM 
    DM.CNF_CUSTOMER_APU_CS_DAILY X,RAPOR_SIL T
  WHERE X.PARTY_ID = T.PARTY_ID
    AND X.DATA_DATE=T.DATA_DATE 
  ),
  CUST_BAL_SUM AS (
  SELECT /*+ MATERIALIZE */
     D.PARTY_ID
    ,D.DATA_DATE
    ,NVL(GPL_PRINCIPAL_AMOUNT_TL,0)AS GPL_KULLANDIRIM
    ,NVL(MORTGAGE_PRINCIPAL_AMOUNT_TL,0) AS MORTGAGE_KULLANDIRIM
  FROM 
    DM.CNF_CUSTOMER_BALANCE_SUM_DAILY D,RAPOR_SIL T
  WHERE D.PARTY_ID = T.PARTY_ID
    AND D.DATA_DATE=T.DATA_DATE
  ),
  CUST_DEMAND_DEP AS   (
  SELECT /*+ MATERIALIZE */
     PARTY_ID
    ,DATA_DATE
    ,SUM(VADESIZ_TL_BAKIYE) AS VADESIZ_TL_BAKIYE 
    ,SUM(VADESIZ_FX_BAKIYE) AS VADESIZ_FX_BAKIYE
    ,SUM(VADESIZ_FX_USD) AS VADESIZ_FX_USD
  FROM
  (
  SELECT /*+ MATERIALIZE */
     X.PARTY_ID 
    ,X.DATA_DATE
    ,X.CONTRACT_ID
    ,CASE WHEN CURRENCY_CODE='TRY' THEN SUM(MTD_BALANCE_TL) ELSE 0 END AS VADESIZ_TL_BAKIYE
    ,CASE WHEN CURRENCY_CODE<>'TRY' THEN SUM(MTD_BALANCE_TL) ELSE 0 END AS VADESIZ_FX_BAKIYE
    ,CASE WHEN CURRENCY_CODE<>'TRY' THEN SUM(MTD_BALANCE_USD) ELSE 0 END AS VADESIZ_FX_USD  
  FROM 
    EDW.CON_BALANCE X,
    RAPOR_SIL T 
  WHERE X.PARTY_ID=T.PARTY_ID AND X.DATA_DATE = T.DATA_DATE
    AND CONTRACT_ID > 0
    AND X.SOURCE_SYSTEM_ID=70
    AND 
    (
      SUBSTR(GL_CODE,1,5) IN ('30000','30001','30200','30201','30500','30510','30400','30401','30402','30403','30404','30405','30448') 
    OR 
      SUBSTR(GL_CODE,1,6) IN
      ('301000','301001','301100','301101','301030','301031','301120','301121','304200','304201','304210','304211','304220','304221',
      '304230','304231','304240','304241','304250','304251','304260','304261','304270','304271','304280','304281','304400','304401',
      '304410','304411','304420','304421','304440','304441','304450','304451','304460','304461','304470','304471','304590',
      '304591','305031','305039','305121','305129','306000','306001','306010','306011','306990','306991') 
    )
  GROUP BY
    X.PARTY_ID 
    ,X.CONTRACT_ID
    ,X.DATA_DATE
    ,CURRENCY_CODE
  )
  GROUP BY
    PARTY_ID
    ,DATA_DATE
  ),
  CUST_TIME_DEP AS   (
SELECT /*+ MATERIALIZE */ 
   PARTY_ID
    ,DATA_DATE
    ,SUM(EDEPOSIT_TL_ADET) AS EDEPOSIT_TL_ADET
    ,SUM(EDEPOSIT_FX_ADET) AS EDEPOSIT_FX_ADET
    ,SUM(OZEL_ADET) AS OZEL_ADET
    ,SUM(KONTRAT_ADEDI) AS KONTRAT_ADEDI
    ,SUM(TL_ADET) AS TL_ADET
    ,SUM(FX_ADET) AS FX_ADET    
    ,SUM(E_VADELI_TL_BAKIYE) AS E_VADELI_TL_BAKIYE
    ,SUM(E_VADELI_FX_BAKIYE) AS E_VADELI_FX_BAKIYE
    ,SUM(TL_BAKIYE) AS VADELI_TL_BAKIYE
    ,SUM(FX_BAKIYE) AS VADELI_FX_BAKIYE
    ,SUM(YENI_TDEP_TL_ADET) AS YENI_TDEP_TL_ADET
    ,SUM(YENI_TDEP_FX_ADET) AS YENI_TDEP_FX_ADET    
    ,SUM(YENI_TDEP_TL_BAKIYE) AS YENI_TDEP_TL_BAKIYE
    ,SUM(YENI_TDEP_FX_BAKIYE) AS YENI_TDEP_FX_BAKIYE    
    ,SUM(YENI_TL_INTEREST_RATE)/NULLIF(SUM(YENI_TDEP_TL_ADET),0) AS YENI_TL_ORTALAMA_ORAN
    ,SUM(YENI_FX_INTEREST_RATE)/NULLIF(SUM(YENI_TDEP_FX_ADET),0) AS YENI_FX_ORTALAMA_ORAN
    ,SUM(STOK_TL_INTEREST_RATE)/NULLIF(SUM(TL_ADET)-SUM(YENI_TDEP_TL_ADET),0)  AS STOK_TL_ORTALAMA_ORAN
    ,SUM(STOK_FX_INTEREST_RATE)/NULLIF(SUM(FX_ADET)-SUM(YENI_TDEP_FX_ADET),0) AS STOK_FX_ORTALAMA_ORAN        
  FROM
  (
  SELECT 
     T.PARTY_ID
    ,X.DATA_DATE
    ,CASE WHEN LENGTH(TREASURY_REF)>1 THEN COUNT(DISTINCT X.CONTRACT_ID) ELSE 0 END AS OZEL_ADET    
    ,CASE WHEN X.CURRENCY_CODE='TRY' THEN COUNT(DISTINCT X.CONTRACT_ID) ELSE 0 END AS TL_ADET
    ,CASE WHEN X.CURRENCY_CODE<>'TRY' THEN COUNT(DISTINCT X.CONTRACT_ID) ELSE 0 END AS FX_ADET      
    ,CASE WHEN ORIGINATOR_CHANNEL_ID IN (7,15) AND X.CURRENCY_CODE='TRY' THEN COUNT(DISTINCT X.CONTRACT_ID) ELSE 0 END AS EDEPOSIT_TL_ADET    
    ,CASE WHEN ORIGINATOR_CHANNEL_ID IN (7,15) AND X.CURRENCY_CODE<>'TRY' THEN COUNT(DISTINCT X.CONTRACT_ID) ELSE 0 END AS EDEPOSIT_FX_ADET     
    ,CASE WHEN TO_CHAR(CONTRACT_OPEN_DATE,'YYYYMM')=TO_CHAR(X.DATA_DATE,'YYYYMM') AND X.CURRENCY_CODE='TRY'  THEN COUNT(DISTINCT X.CONTRACT_ID) ELSE 0 END AS YENI_TDEP_TL_ADET
    ,CASE WHEN TO_CHAR(CONTRACT_OPEN_DATE,'YYYYMM')=TO_CHAR(X.DATA_DATE,'YYYYMM') AND X.CURRENCY_CODE<>'TRY' THEN COUNT(DISTINCT X.CONTRACT_ID) ELSE 0 END AS YENI_TDEP_FX_ADET 
    ,COUNT(DISTINCT X.CONTRACT_ID) AS KONTRAT_ADEDI
    ,CASE WHEN X.CURRENCY_CODE='TRY' AND TO_CHAR(CONTRACT_OPEN_DATE,'YYYYMM')=TO_CHAR(X.DATA_DATE,'YYYYMM') THEN SUM(CURR_INTEREST_RATE) ELSE 0 END AS YENI_TL_INTEREST_RATE
    ,CASE WHEN X.CURRENCY_CODE<>'TRY' AND TO_CHAR(CONTRACT_OPEN_DATE,'YYYYMM')=TO_CHAR(X.DATA_DATE,'YYYYMM') THEN SUM(CURR_INTEREST_RATE) ELSE 0 END AS YENI_FX_INTEREST_RATE    
    ,CASE WHEN X.CURRENCY_CODE='TRY' AND TO_CHAR(CONTRACT_OPEN_DATE,'YYYYMM')<>TO_CHAR(X.DATA_DATE,'YYYYMM') THEN SUM(CURR_INTEREST_RATE) ELSE 0 END AS STOK_TL_INTEREST_RATE
    ,CASE WHEN X.CURRENCY_CODE<>'TRY' AND TO_CHAR(CONTRACT_OPEN_DATE,'YYYYMM')<>TO_CHAR(X.DATA_DATE,'YYYYMM') THEN SUM(CURR_INTEREST_RATE) ELSE 0 END AS STOK_FX_INTEREST_RATE    
    ,CASE WHEN X.CURRENCY_CODE<>'TRY' THEN SUM(CURR_INTEREST_RATE) ELSE 0 END AS FX_INTEREST_RATE   
    ,CASE WHEN ORIGINATOR_CHANNEL_ID IN (7,15) AND X.CURRENCY_CODE='TRY' THEN SUM(MTD_BALANCE_TL) ELSE 0 END AS E_VADELI_TL_BAKIYE
    ,CASE WHEN ORIGINATOR_CHANNEL_ID IN (7,15) AND X.CURRENCY_CODE<>'TRY' THEN SUM(MTD_BALANCE_TL) ELSE 0 END AS E_VADELI_FX_BAKIYE   
    ,CASE WHEN TO_CHAR(CONTRACT_OPEN_DATE,'YYYYMM')=TO_CHAR(X.DATA_DATE,'YYYYMM') AND X.CURRENCY_CODE='TRY'  THEN SUM(MTD_BALANCE_TL) ELSE 0 END AS YENI_TDEP_TL_BAKIYE
    ,CASE WHEN TO_CHAR(CONTRACT_OPEN_DATE,'YYYYMM')=TO_CHAR(X.DATA_DATE,'YYYYMM') AND X.CURRENCY_CODE<>'TRY' THEN SUM(MTD_BALANCE_TL) ELSE 0 END AS YENI_TDEP_FX_BAKIYE
    ,CASE WHEN X.CURRENCY_CODE='TRY' THEN SUM(MTD_BALANCE_TL) ELSE 0 END AS TL_BAKIYE
    ,CASE WHEN X.CURRENCY_CODE<>'TRY' THEN SUM(MTD_BALANCE_TL) ELSE 0 END AS FX_BAKIYE          
  FROM 
    EDW.CON_BALANCE X
    JOIN RAPOR_SIL T ON X.PARTY_ID=T.PARTY_ID AND X.DATA_DATE = T.DATA_DATE
    LEFT OUTER JOIN EDW.CON_TIME_DEPOSIT A ON X.CONTRACT_ID=A.CONTRACT_ID
    LEFT OUTER JOIN DM.CNF_PRODUCT B ON A.PRODUCT_ID=B.PRODUCT_ID
  WHERE 
    X.SOURCE_SYSTEM_ID=69   
    AND PRODUCT_NAME<>'Çalışan Vadeli Hesap'
    AND 
      (
        SUBSTR(X.GL_CODE,1,5) IN ('31500','31501','31510','31511','32000','32001','32100','32101','32400','32401','32500','32502','32501','32503') 
      OR 
        SUBSTR(X.GL_CODE,1,6) IN
        ('310000','310001','310002','310003','310004','310005','310006','310007','310008','310009','310010','310011',
        '310012','310013','310014','310015','310016','310017','310018','310019','311000','311001','311002','311003','311004','311005','311006',
        '311007','311008','311009','311010','311011','311012','311013','311014','311015','311016','311017','311018','311019','311100','311101',
        '311102','311103','311104','311105','311106','311107','311108','311109','311110','311111','311112','311113','311114','311115','311116',
        '311117','311118','311119','312000','312001','312002','312003','312004','312005','312006','312007','312008','312009','312010','312011',
        '312012','312013','312014','312015','312016','312017','312018','312019','311030','311031','311032','311033','311034','311035','311036',
        '311037','311038','311039','311040','311041','311042','311043','311044','311045','311046','311047','311048','311049','311120','311121',
        '311122','311123','311124','311125','311126','311127','311128','311129','311130','311131','311132','311133','311134','311135','311136',
        '311137','311138','311139','314000','314001','314002','314003','314004','314010','314011','314012','314013','314014','314020','314021',
        '314022','314023','314024','314030','314031','314032','314033','314034','314040','314041','314042','314043','314044','314050','314051',
        '314052','314053','314054','314200','314201','314202','314203','314204','314205','314206','314207','314208','314209','314210','314211',
        '314212','314213','314214','314215','314216','314217','314218','314219','314220','314221','314222','314223','314224','314225','314226',
        '314227','314228','314229','314230','314231','314232','314233','314234','314235','314236','314237','314238','314239','314240','314241',
        '314242','314243','314244','314245','314246','314247','314248','314249','314250','314251','314252','314253','314254','314255','314256',
        '314257','314258','314259','314260','314261','314262','314263','314264','314265','314266','314267','314268','314269','314270','314271',
        '314272','314273','314274','314275','314276','314277','314278','314279','314280','314281','314282','314283','314284','314285','314286',
        '314287','314288','314289','314290','314291','314292','314293','314294','314295','314296','314297','314298','314299','314300','314301',
        '314302','314303','314304','314305','314306','314307','314308','314309','314310','314311','314312','314313','314314','314315','314316',
        '314317','314318','314319','314320','314321','314322','314323','314324','314325','314326','314327','314328','314329','314330','314331',
        '314332','314333','314334','314335','314336','314337','314338','314339','314340','314341','314342','314343','314344','314345','314346',
        '314347','314348','314349','314350','314351','314352','314353','314354','314355','314356','314357','314358','314359','314360','314361',
        '314362','314363','314364','314365','314366','314367','314368','314369','314370','314371','314372','314373','314374','314375','314376',
        '314377','314378','314379','314400','314401','314402','314403','314404','314405','314406','314407','314408','314409','314410','314411',
        '314412','314413','314414','314415','314416','314417','314418','314419','314420','314421','314422','314423','314424','314425','314426',
        '314427','314428','314429','314440','314441','314442','314443','314444','314445','314446','314447','314448','314449','314450','314451',
        '314452','314453','314454','314455','314456','314457','314458','314459','314460','314461','314462','314463','314464','314465','314466',
        '314467','314468','314469','314470','314471','314472','314473','314474','314475','314476','314477','314478','314479','314480','314481',
        '314482','314483','314484','314485','314486','314487','314488','314489','314590','314591','314592','314593','314594','314595','314596',
        '314597','314598','314599','314600','314601','314602','314603','314604','314605','314606','314607','314608','314609','314610','314611',
        '314612','314613','314614','314615','314616','314617','314618','314619','314620','314621','314622','314623','314624','314625','314626',
        '314627','314628','314629','314640','314641','314642','314643','314644','314645','314646','314647','314648','314649','314650','314651',
        '314652','314653','314654','314655','314656','314657','314658','314659','314660','314661','314662','314663','314664','314665','314666',
        '314667','314668','314669','314670','314671','314672','314673','314674','314675','314676','314677','314678','314679','314680','314681',
        '314682','314683','314684','314685','314686','314687','314688','314689','314700','314701','314702','314703','314704','314705','314706',
        '314707','314708','314709','315031','315039','315041','315049','315121','315129','315131','315139','316000','316001','316002','316003',
        '316004','316005','316006','316007','316008','316009','316010','316011','316012','316013','316014','316015','316016','316017','316018',
        '316019','316090','316091','316092','316093','316094','316095','316096','316097','316098','316099','316100','316101','316102','316103',
        '316104','316105','316106','316107','316108','316109','316110','316111','316112','316113','316114','316115','316116','316117','316118',
        '316119','316190','316191','316192','316193','316194','316195','316196','316197','316198','316199','324020','324021','324022','324023',
        '324024','324025','324026','324027','324028','324030','324031','324032','324033','324034','324035','324036','324037','324039','324040',
        '324041','324042')
      )
  GROUP BY
     T.PARTY_ID
    ,X.DATA_DATE
    ,TREASURY_REF
    ,X.CURRENCY_CODE
    ,ORIGINATOR_CHANNEL_ID 
    ,TO_CHAR(CONTRACT_OPEN_DATE,'YYYYMM')
  )
  GROUP BY
    PARTY_ID
    ,DATA_DATE
  ),
  CUST_HB AS (
SELECT /*+ MATERIALIZE */
     D.PARTY_ID
    ,D.DATA_DATE
    ,MAX(D.HB_FLG) HB_FLG
  FROM
    DM.CNF_INDV_CUST_HB_SCORE_DAILY D,RAPOR_SIL T
  WHERE D.HB_FLG=1
    AND D.PARTY_ID=T.PARTY_ID AND D.DATA_DATE=T.DATA_DATE
  GROUP BY D.PARTY_ID,D.DATA_DATE
  ),
  CUST_BILL_ORDER AS (
SELECT /*+ MATERIALIZE */
   A.ORDER_PARTY_ID AS PARTY_ID
  ,MAX(ORDER_CLOSE_DATE) AS FATURA_KAPANIS                
  ,1 AS FLAG
  ,T.DATA_DATE
FROM
  EDW.PCO_BILL_ORDER  A
  ,EDW.PCO_CORPORATION B 
  ,EDW.CHN_CHANNEL C
  ,RAPOR_SIL T
WHERE 
  A.CORPORATION_ID=B.CORPORATION_ID
    AND A.CHANNEL_ID=C.CHANNEL_ID
    AND B.SOURCE_SYS_PRODUCT_CODE IN ('CEPTEL','DOĞALGAZ','ELEKTRİK','SU','TAHSILAT','TAHSİLAT', 'TELEKOM') 
    AND A.AUTO_PAYMENT_FLG=1 
    AND T.PARTY_ID=A.ORDER_PARTY_ID AND T.DATA_DATE<ORDER_CLOSE_DATE
GROUP BY
  A.ORDER_PARTY_ID,T.DATA_DATE
),
CUST_CONTRACT AS 
(
SELECT /*+ MATERIALIZE */
  DM.CNF_CONTRACT.PRIMARY_OWNER_PARTY_ID AS PARTY_ID
  ,1 AS FLAG
  ,M.DATA_DATE
FROM
  EDW.CON_X_CONTRACT,
  EDW.CON_X_CONTRACT_TP_LKP,
  DM.CNF_CONTRACT,
  RAPOR_SIL M
WHERE
  1=1
  AND CNF_CONTRACT.PRIMARY_OWNER_PARTY_ID=M.PARTY_ID AND M.DATA_DATE BETWEEN CON_X_CONTRACT.START_DATE AND CON_X_CONTRACT.END_DATE
  AND DM.CNF_CONTRACT.CONTRACT_ID = EDW.CON_X_CONTRACT.RELATED_CONTRACT_ID 
  AND EDW.CON_X_CONTRACT.CONTRACT_REL_TP_ID = EDW.CON_X_CONTRACT_TP_LKP.CONTRACT_REL_TP_ID
  AND EDW.CON_X_CONTRACT_TP_LKP.CONTRACT_REL_TP_CODE = '10'
GROUP BY DM.CNF_CONTRACT.PRIMARY_OWNER_PARTY_ID,M.DATA_DATE
),
CUST_CARD_TRX AS
(
  SELECT /*+ MATERIALIZE */
  T.PARTY_ID
  ,1 AS FLAG
  ,MAX(TRANSACTION_POST_DATE) AS ODEME_GECERLILIK
  ,M.DATA_DATE
FROM 
  EDW.TRX_CARD_TRANSACTION T,EDW.TRX_CARD_TRX_TERM_TP_LKP CTL, EDW.TRX_CARD_TRANSACTION_TP_LKP TL, RAPOR_SIL M,TARIH TAR
WHERE 
  CTL.TRANSACTION_TERMINAL_TP_ID = T.TRANSACTION_TERMINAL_TP_ID
  AND TL.CARD_TRANSACTION_TP_ID = T.CARD_TRANSACTION_TP_ID
  AND CTL.TRANSACTION_TERMINAL_TP_CODE ='OS'
  AND TL.OTS_CODE = '1003'
  AND TRANSACTION_AMOUNT_TL > 0
  AND T.PARTY_ID=M.PARTY_ID
  AND T.TRANSACTION_POST_DATE BETWEEN M.DATA_DATE-45 AND M.DATA_DATE 
  AND T.TRANSACTION_POST_DATE BETWEEN MIN_DT AND MAX_DT
GROUP BY
  T.PARTY_ID,M.DATA_DATE
),
CUST_BILL_TRX AS 
(
SELECT /*+ MATERIALIZE */
   A.PARTY_ID
  ,1 AS FLAG
  ,MAX(A.TRANSACTION_DATE) AS FATURA_TARIH
  ,T.DATA_DATE
FROM 
  EDW.PCO_BILL_TRANSACTION A,
  EDW.PCO_CORPORATION D,
  EDW.PCO_BILL_ORDER F,
  EDW.PCO_ORDER_STAT_HST G,
  RAPOR_SIL T
WHERE
  A.PARTY_ID=T.PARTY_ID
  AND A.TRANSACTION_DATE BETWEEN T.DATA_DATE-45 AND T.DATA_DATE
  AND D.CORPORATION_ID = A.CORPORATION_ID
  AND A.TRANSACTION_STAT_ID =1
  AND A.ORDER_ID = F.ORDER_ID
  AND F.ORDER_ID = G.ORDER_ID
  AND A.TRANSACTION_INSTRUMENT_TP_ID IN (1,4)
  AND G.ORDER_STAT_ID =1
  AND A.AUTO_PAYMENT_FLG=1
  AND D.SOURCE_SYS_PRODUCT_CODE IN ('CEPTEL','DOĞALGAZ','ELEKTRİK','SU','TAHSILAT','TAHSİLAT', 'TELEKOM')
GROUP BY 
  A.PARTY_ID,T.DATA_DATE
),
CUST_MAAS AS   (
  SELECT /*+ MATERIALIZE */
             T.DATA_DATE,
             ST.PARTY_ID,  
             1 AS MAAS_FLAG
        FROM EDW.PCO_SALARY_TRANSACTION  ST,
             EDW.PCO_CORPORATION         C,
             EDW.PCO_PAYMENT_TP_LKP      LKP,
             EDW.PCO_TRANSACTION_STAT_LKP ST_LKP,
             RAPOR_SIL T
        WHERE  ST.PARTY_ID=T.PARTY_ID 
             AND ST.TRANSACTION_DATE BETWEEN TRUNC(ADD_MONTHS (T.DATA_DATE,-2),'MM') AND T.DATA_DATE
             AND ST.TRANSACTION_STAT_ID = ST_LKP.TRANSACTION_STAT_ID
             AND ST_LKP.TRANSACTION_STAT_CODE IN ('1', '5')
             AND C.CORPORATION_ID = ST.CORPORATION_ID
             AND C.CORPORATION_CODE NOT IN ('VEHBIBURS',
                                            'TEV',
                                            'ISLEMDSTK1',
                                            'BILB',
                                            'VKVBURS',
                                            'YKB',
                                            'ISLEMDSTK2',
                                            'MIM',
                                            'YKBODEME',
                                            'CYDD',
                                            'KOYHIZML',
                                            'OKMSCY2',
                                            'TABCAY',
                                            'KARALICAY',
                                            'OKMSCY',
                                            'KK IY ODEM',
                                            'GURCAY',
                                            '7696989')
             AND ST.PAYMENT_TP_ID = LKP.PAYMENT_TP_ID
             AND LKP.PAYMENT_TP_CODE IN ('M', '4', 'A')            
             AND C.SOURCE_SYSTEM_ID = (SELECT SOURCE_SYSTEM_ID
                                         FROM EDW.CMN_SOURCE_SYSTEM_LKP
                                        WHERE SOURCE_SYSTEM_CODE = 'SALARY')
             AND LKP.SOURCE_SYSTEM_ID = (SELECT SOURCE_SYSTEM_ID
                                           FROM EDW.CMN_SOURCE_SYSTEM_LKP
                                          WHERE SOURCE_SYSTEM_CODE = 'SALARY')
             AND C.PARTY_ID <> ST.PARTY_ID
             AND ST.PARTY_ID>0
    GROUP BY T.DATA_DATE,
             ST.PARTY_ID
) 
SELECT 
   DATA_DATE
  ,T0_PORTFOLIO_SBU_CODE 
  
  ,COUNT(DISTINCT PARTY_ID) AS MUSTERI_ADEDI  
  ,SUM(DORMANT_FLAG) AS DORMANT_MUSTERI_ADEDI
  ,SUM(CCO_FLAG) AS CCO_MUSTERI_ADEDI
  ,SUM(AKTIF_FLAG) AS AKTIF_MUSTERI_ADEDI
  ,SUM(YENI_FLAG) AS YENI_MUSTERI_ADEDI
  ,SUM(MAAS_FLAG) AS MAAS_MUSTERI_ADEDI
  ,SUM(MAAS_FLAG)/COUNT(DISTINCT PARTY_ID) AS MAAS_PENETRASYON
  ,SUM(HOUSEBANK_FLAG)/COUNT(DISTINCT PARTY_ID) AS HOUSEBANK_PENETRASYON  
  ,SUM(ONLY_TIME_DEPOSIT_FLG)/COUNT(DISTINCT PARTY_ID) AS ONLY_TIME_DEPOSIT_PENETRASYON
  ,SUM(ONLY_MORTGAGE_FLG)/COUNT(DISTINCT PARTY_ID) AS ONLY_MORTGAGE_PENETRASYON 
  ,SUM(CSELL)/COUNT(DISTINCT PARTY_ID) AS ORTALAMA_CS
  ,SUM(APU)/COUNT(DISTINCT PARTY_ID) AS ORTALAMA_APU
  ,SUM(PFA)/COUNT(DISTINCT PARTY_ID) AS ORTALAMA_PFA 
  ,SUM(OWN_OVERDRAFT_FLG)/COUNT(DISTINCT PARTY_ID) AS EH_PENETRASYON
  ,SUM(ACTV_GPL_FLG)/COUNT(DISTINCT PARTY_ID) AS BIK_PENETRASYON    
  ,SUM(KULLANDIRIM_TUTAR)/NULLIF(SUM(BIK_ADET),0) AS BIK_ORTALAMA_KULLANDIRIM
  ,SUM(ACTV_MORTGAGE_FLG)/COUNT(DISTINCT PARTY_ID)  AS MORTGAGE_PENETRASYON
  ,SUM(MORTGAGE_KULLANDIRIM_TUTAR)/NULLIF(SUM(ACTV_MORTGAGE_FLG),0) AS MORTGAGE_ORTALAMA_KULLANDIRIM
  ,SUM(OWN_CC_FLG)/COUNT(DISTINCT PARTY_ID) AS KK_SAHIPLIK_PENETRASYON
  ,SUM(ACTV_CC_FLG)/COUNT(DISTINCT PARTY_ID) AS KK_AKTIFLIK_PENETRASYON
  ,SUM(KK_ORDER_SAHIPLIK)/COUNT(DISTINCT PARTY_ID) AS KK_ORDER_SAHIPLIK_PENETRASYON
  ,SUM(KK_ORDER_AKTIFLIK)/COUNT(DISTINCT PARTY_ID) AS KK_ORDER_AKTIFLIK_PENETRASYON    
  ,SUM(FATURA_SAHIPLIK)/COUNT(DISTINCT PARTY_ID) AS FATURA_SAHIPLIK_PENETRASYON 
  ,SUM(FATURA_AKTIFLIK)/COUNT(DISTINCT PARTY_ID) AS FATURA_AKTIFLIK_PENETRASYON     
  ,SUM(ACTV_DEMAND_DEPOSIT_TL_FLG)/COUNT(DISTINCT PARTY_ID) AS VADESIZ_TL_PENETRASYON
  ,SUM(VADESIZ_TL_BAKIYE)/NULLIF(SUM(ACTV_DEMAND_DEPOSIT_TL_FLG),0) AS VADESIZ_TL_ORTALAMA  
  ,SUM(MAAS_VADESIZ_TL_BAKIYE)/NULLIF(SUM(MAAS_VADESIZ_TL_FLAG),0) AS MAAS_VADESIZ_TL_ORTALAMA
  ,SUM(NONMAAS_VADESIZ_TL_BAKIYE)/NULLIF(SUM(NONMAAS_VADESIZ_TL_FLAG),0) AS NONMAAS_VADESIZ_TL_ORTALAMA 
  ,SUM(ACTV_DEMAND_DEPOSIT_FX_FLG)/COUNT(DISTINCT PARTY_ID) AS VADESIZ_FX_PENETRASYON 
  ,SUM(VADESIZ_FX_BAKIYE)/NULLIF(SUM(ACTV_DEMAND_DEPOSIT_FX_FLG),0) AS VADESIZ_FX_ORTALAMA
  ,SUM(MAAS_VADESIZ_FX_BAKIYE)/NULLIF(SUM(MAAS_VADESIZ_FX_FLAG),0) AS MAAS_VADESIZ_FX_ORTALAMA
  ,SUM(NONMAAS_VADESIZ_FX_BAKIYE)/NULLIF(SUM(NONMAAS_VADESIZ_FX_FLAG),0) AS NONMAAS_VADESIZ_FX_ORTALAMA
  ,SUM(ACTV_TIME_DEPOSIT_TL_FLG) AS VADELI_TL_MUSTERI_ADEDI
  ,SUM(ACTV_TIME_DEPOSIT_TL_FLG)/COUNT(DISTINCT PARTY_ID) AS VADELI_TL_PENETRASYON 
  ,SUM(VADELI_TL_BAKIYE)/NULLIF(SUM(ACTV_TIME_DEPOSIT_TL_FLG),0) AS VADELI_TL_ORTALAMA  
  ,SUM(EDEPOSIT_TL_ADET)/NULLIF(SUM(TL_ADET),0) AS EDEPOSIT_TL_ORAN   
  ,SUM(E_VADELI_TL_BAKIYE)/NULLIF(SUM(VADELI_TL_BAKIYE),0)  AS EDEPOSIT_TL_BAKIYE_ORAN
  ,SUM(YENI_TDEP_TL_ADET)/NULLIF(SUM(TL_ADET),0) AS NEW_DEPOSIT_TL_ORAN  
  ,SUM(YENI_TDEP_TL_BAKIYE)/NULLIF(SUM(VADELI_TL_BAKIYE),0)  AS NEW_DEPOSIT_TL_BAKIYE_ORAN
  ,SUM(MAAS_VADELI_TL_BAKIYE)/NULLIF(SUM(MAAS_VADELI_TL_FLAG),0)  AS MAAS_VADELI_TL_ORTALAMA
  ,SUM(NONMAAS_VADELI_TL_BAKIYE)/NULLIF(SUM(NONMAAS_VADELI_TL_FLAG),0) AS NONMAAS_VADELI_TL_ORTALAMA  
  ,SUM(ACTV_TIME_DEPOSIT_FX_FLG) AS VADELI_FX_MUSTERI_ADEDI 
  ,SUM(ACTV_TIME_DEPOSIT_FX_FLG)/COUNT(DISTINCT PARTY_ID) AS VADELI_FX_PENETRASYON 
  ,SUM(VADELI_FX_BAKIYE)/NULLIF(SUM(ACTV_TIME_DEPOSIT_FX_FLG),0)   AS VADELI_FX_ORTALAMA
  ,SUM(EDEPOSIT_FX_ADET)/NULLIF(SUM(FX_ADET),0) AS EDEPOSIT_FX_ORAN
  ,SUM(E_VADELI_FX_BAKIYE)/NULLIF(SUM(VADELI_FX_BAKIYE),0)   AS EDEPOSIT_FX_BAKIYE_ORAN
  ,SUM(YENI_TDEP_FX_ADET)/NULLIF(SUM(FX_ADET),0) AS NEW_DEPOSIT_FX_ORAN     
  ,SUM(YENI_TDEP_FX_BAKIYE)/NULLIF(SUM(VADELI_FX_BAKIYE),0) AS NEW_DEPOSIT_FX_BAKIYE_ORAN 
  ,SUM(MAAS_VADELI_FX_BAKIYE)/NULLIF(SUM(MAAS_VADELI_FX_FLAG),0) AS MAAS_VADELI_FX_ORTALAMA
  ,SUM(NONMAAS_VADELI_FX_BAKIYE)/NULLIF(SUM(NONMAAS_VADELI_FX_FLAG),0) AS NONMAAS_VADELI_FX_ORTALAMA  
  ,SUM(OZEL_ADET)/NULLIF(SUM(KONTRAT_ADEDI),0) AS REFERANS_KONTRAT_ORAN  
  ,SUM(YENI_FX_ORTALAMA_ORAN)/NULLIF(SUM(YENI_TDEP_FX_ADET),0) AS YENI_FX_ORTALAMA_FAIZ_ORAN 
  ,SUM(YENI_TL_ORTALAMA_ORAN)/NULLIF(SUM(YENI_TDEP_TL_ADET),0) AS YENI_TL_ORTALAMA_FAIZ_ORAN  
  ,SUM(STOK_FX_ORTALAMA_ORAN)/NULLIF(SUM(FX_ADET)-SUM(YENI_TDEP_FX_ADET),0) AS STOK_FX_ORTALAMA_FAIZ_ORAN 
  ,SUM(STOK_TL_ORTALAMA_ORAN)/NULLIF(SUM(TL_ADET)-SUM(YENI_TDEP_TL_ADET),0) AS STOK_TL_ORTALAMA_FAIZ_ORAN  
  ,SUM(MIGRATABLE_ISLEM_FLAG)/COUNT(DISTINCT PARTY_ID) AS SUBE_ISLEM_ORAN
  ,SUM(SUBE_ISLEM_FLAG)/COUNT(DISTINCT PARTY_ID) AS MUSTERI_SUBE_ISLEM_ORAN  
FROM
(
SELECT 
  X.PARTY_ID 
  ,X.DATA_DATE
  ,T0_PORTFOLIO_SBU_CODE
  ,CASE WHEN CUSTOMER_STATUS_DESC IN ('Hareketsiz','Hareketsiz Havuz') THEN 1 ELSE 0 END AS DORMANT_FLAG
  ,CASE WHEN CUSTOMER_STATUS_DESC IN ('Sadece Kart Aktif') THEN 1 ELSE 0 END AS CCO_FLAG
  ,CASE WHEN CUSTOMER_STATUS_DESC IN ('Aktif') THEN 1 ELSE 0 END AS AKTIF_FLAG
  ,CASE WHEN CUSTOMER_STATUS_DESC IN ('Yeni') THEN 1 ELSE 0 END AS YENI_FLAG  
  ,NVL(O.HB_FLG,0) AS HOUSEBANK_FLAG
  ,NVL(V.MAAS_FLAG,0) AS MAAS_FLAG
  ,NVL(CSELL,0) AS CSELL
  ,NVL(APU,0) AS APU
  ,NVL(PFA,0) AS PFA
  ,NVL(C.ACTV_DEMAND_DEPOSIT_TL_FLG,0) AS ACTV_DEMAND_DEPOSIT_TL_FLG
  ,NVL(C.ACTV_DEMAND_DEPOSIT_FX_FLG,0) AS ACTV_DEMAND_DEPOSIT_FX_FLG
  ,NVL(H.VADESIZ_TL_BAKIYE,0) AS VADESIZ_TL_BAKIYE
  ,NVL(H.VADESIZ_FX_BAKIYE,0)  AS VADESIZ_FX_BAKIYE
  ,NVL(H.VADESIZ_FX_USD,0) AS VADESIZ_FX_USD
  ,CASE WHEN NVL(V.MAAS_FLAG,0)=1 THEN NVL(H.VADESIZ_TL_BAKIYE,0) ELSE 0 END AS MAAS_VADESIZ_TL_BAKIYE
  ,CASE WHEN NVL(V.MAAS_FLAG,0)=0 THEN NVL(H.VADESIZ_TL_BAKIYE,0) ELSE 0 END AS NONMAAS_VADESIZ_TL_BAKIYE
  ,CASE WHEN NVL(V.MAAS_FLAG,0)=1 THEN NVL(H.VADESIZ_FX_BAKIYE,0) ELSE 0 END AS MAAS_VADESIZ_FX_BAKIYE
  ,CASE WHEN NVL(V.MAAS_FLAG,0)=0 THEN NVL(H.VADESIZ_FX_BAKIYE,0) ELSE 0 END AS NONMAAS_VADESIZ_FX_BAKIYE
  ,CASE WHEN NVL(V.MAAS_FLAG,0)=1 THEN NVL(C.ACTV_DEMAND_DEPOSIT_TL_FLG,0) ELSE 0 END AS MAAS_VADESIZ_TL_FLAG
  ,CASE WHEN NVL(V.MAAS_FLAG,0)=0 THEN NVL(C.ACTV_DEMAND_DEPOSIT_TL_FLG,0) ELSE 0 END AS NONMAAS_VADESIZ_TL_FLAG
  ,CASE WHEN NVL(V.MAAS_FLAG,0)=1 THEN NVL(C.ACTV_DEMAND_DEPOSIT_FX_FLG,0) ELSE 0 END AS MAAS_VADESIZ_FX_FLAG
  ,CASE WHEN NVL(V.MAAS_FLAG,0)=0 THEN NVL(C.ACTV_DEMAND_DEPOSIT_FX_FLG,0) ELSE 0 END AS NONMAAS_VADESIZ_FX_FLAG
  ,NVL(C.ACTV_TIME_DEPOSIT_TL_FLG,0) AS ACTV_TIME_DEPOSIT_TL_FLG
  ,NVL(C.ACTV_TIME_DEPOSIT_FX_FLG,0) AS ACTV_TIME_DEPOSIT_FX_FLG
  ,NVL(I.VADELI_TL_BAKIYE,0) AS VADELI_TL_BAKIYE
  ,NVL(I.VADELI_FX_BAKIYE,0) AS VADELI_FX_BAKIYE
  ,NVL(EDEPOSIT_TL_ADET,0) EDEPOSIT_TL_ADET
  ,NVL(TL_ADET,0)  TL_ADET
  ,NVL(EDEPOSIT_FX_ADET,0) EDEPOSIT_FX_ADET
  ,NVL(FX_ADET,0) FX_ADET
  ,NVL(OZEL_ADET,0)OZEL_ADET
  ,NVL(E_VADELI_TL_BAKIYE,0) E_VADELI_TL_BAKIYE
  ,NVL(E_VADELI_FX_BAKIYE,0) E_VADELI_FX_BAKIYE
  ,NVL(YENI_FX_ORTALAMA_ORAN,0) YENI_FX_ORTALAMA_ORAN
  ,NVL(YENI_TL_ORTALAMA_ORAN,0) YENI_TL_ORTALAMA_ORAN
  ,NVL(STOK_FX_ORTALAMA_ORAN,0) STOK_FX_ORTALAMA_ORAN
  ,NVL(STOK_TL_ORTALAMA_ORAN,0) STOK_TL_ORTALAMA_ORAN 
  ,NVL(KONTRAT_ADEDI,0) KONTRAT_ADEDI
  ,NVL(YENI_TDEP_TL_ADET,0) YENI_TDEP_TL_ADET
  ,NVL(YENI_TDEP_FX_ADET,0) YENI_TDEP_FX_ADET
  ,NVL(YENI_TDEP_TL_BAKIYE,0)  YENI_TDEP_TL_BAKIYE
  ,NVL(YENI_TDEP_FX_BAKIYE,0) YENI_TDEP_FX_BAKIYE 
  ,CASE WHEN NVL(V.MAAS_FLAG,0)=1 THEN NVL(C.ACTV_TIME_DEPOSIT_TL_FLG,0) ELSE 0 END AS MAAS_VADELI_TL_FLAG
  ,CASE WHEN NVL(V.MAAS_FLAG,0)=0 THEN NVL(C.ACTV_TIME_DEPOSIT_TL_FLG,0) ELSE 0 END AS NONMAAS_VADELI_TL_FLAG
  ,CASE WHEN NVL(V.MAAS_FLAG,0)=1 THEN NVL(C.ACTV_TIME_DEPOSIT_FX_FLG,0) ELSE 0 END AS MAAS_VADELI_FX_FLAG
  ,CASE WHEN NVL(V.MAAS_FLAG,0)=0 THEN NVL(C.ACTV_TIME_DEPOSIT_FX_FLG,0) ELSE 0 END AS NONMAAS_VADELI_FX_FLAG
  ,CASE WHEN NVL(V.MAAS_FLAG,0)=1 THEN NVL(I.VADELI_TL_BAKIYE,0) ELSE 0 END AS MAAS_VADELI_TL_BAKIYE
  ,CASE WHEN NVL(V.MAAS_FLAG,0)=0 THEN NVL(I.VADELI_TL_BAKIYE,0) ELSE 0 END AS NONMAAS_VADELI_TL_BAKIYE
  ,CASE WHEN NVL(V.MAAS_FLAG,0)=1 THEN NVL(I.VADELI_FX_BAKIYE,0) ELSE 0 END AS MAAS_VADELI_FX_BAKIYE
  ,CASE WHEN NVL(V.MAAS_FLAG,0)=0 THEN NVL(I.VADELI_FX_BAKIYE,0) ELSE 0 END AS NONMAAS_VADELI_FX_BAKIYE    
  ,NVL(ACTV_GPL_FLG,0) AS ACTV_GPL_FLG
  ,NVL(OWN_OVERDRAFT_FLG,0) AS OWN_OVERDRAFT_FLG
  ,NVL(ACTV_MORTGAGE_FLG,0) AS ACTV_MORTGAGE_FLG
  ,NVL(MORTGAGE_KULLANDIRIM,0) AS MORTGAGE_KULLANDIRIM_TUTAR
  ,NVL(MORTGAGE_ADET,0) AS MORTGAGE_ADET
  ,NVL(GPL_KULLANDIRIM,0) AS KULLANDIRIM_TUTAR
  ,NVL(GPL_ADET,0) AS BIK_ADET    
  ,NVL(ACTV_CC_FLG,0) AS ACTV_CC_FLG
  ,NVL(OWN_CC_FLG,0) AS OWN_CC_FLG    
  ,NVL(T.FLAG,0) AS KK_ORDER_SAHIPLIK 
  ,NVL(U.FLAG,0) AS KK_ORDER_AKTIFLIK   
  ,NVL(R.FLAG,0) AS FATURA_SAHIPLIK
  ,NVL(S.FLAG,0) AS FATURA_AKTIFLIK 
  ,NVL(ISLEM_FLAG,0) AS SUBE_ISLEM_FLAG 
  ,NVL(MIGRATABLE_ISLEM_FLAG,0) AS MIGRATABLE_ISLEM_FLAG    
  ,NVL(ONLY_TIME_DEPOSIT_FLG,0) AS ONLY_TIME_DEPOSIT_FLG  
  ,NVL(ONLY_MORTGAGE_FLG,0) AS ONLY_MORTGAGE_FLG   
FROM RAPOR_SIL X
LEFT OUTER JOIN TRX Y ON X.PARTY_ID=Y.PARTY_ID AND Y.WEEK_OF_YEAR=X.WEEK_OF_YEAR   
LEFT OUTER JOIN CUST_SUM A ON X.PARTY_ID=A.PARTY_ID AND X.DATA_DATE=A.DATA_DATE
LEFT OUTER JOIN CUST_APU C ON X.PARTY_ID=C.PARTY_ID AND X.DATA_DATE=C.DATA_DATE
LEFT OUTER JOIN CUST_BAL_SUM D ON X.PARTY_ID=D.PARTY_ID AND X.DATA_DATE=D.DATA_DATE
LEFT OUTER JOIN CUST_DEMAND_DEP H ON X.PARTY_ID=H.PARTY_ID AND X.DATA_DATE=H.DATA_DATE
LEFT OUTER JOIN CUST_TIME_DEP I ON X.PARTY_ID=I.PARTY_ID AND X.DATA_DATE=I.DATA_DATE
LEFT OUTER JOIN CUST_HB O ON X.PARTY_ID=O.PARTY_ID AND X.DATA_DATE=O.DATA_DATE 
LEFT OUTER JOIN CUST_BILL_ORDER R ON X.PARTY_ID=R.PARTY_ID AND X.DATA_DATE=R.DATA_DATE
LEFT OUTER JOIN CUST_BILL_TRX S ON X.PARTY_ID=S.PARTY_ID AND S.DATA_DATE = X.DATA_DATE
LEFT OUTER JOIN CUST_CONTRACT T ON X.PARTY_ID=T.PARTY_ID AND X.DATA_DATE = T.DATA_DATE
LEFT OUTER JOIN CUST_CARD_TRX U ON X.PARTY_ID=U.PARTY_ID AND U.DATA_DATE= X.DATA_DATE
LEFT OUTER JOIN CUST_MAAS V ON X.PARTY_ID=V.PARTY_ID AND X.DATA_DATE=V.DATA_DATE 
)
GROUP BY DATA_DATE ,T0_PORTFOLIO_SBU_CODE



